// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model - id matches Supabase auth.users.id (UUID)
model User {
  id                   String               @id @db.Uuid
  name                 String
  email                String               @unique
  avatar               String?
  phone                String?
  jobTitle             String?
  isActive             Boolean              @default(true)
  emailVerified        DateTime?
  lastLoginAt          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  wikiArticles         WikiArticle[]
  wikiArticleVersions  WikiArticleVersion[]
  createdCourses       Course[]             @relation("CourseCreator")
  enrollments          Enrollment[]
  locations            UserLocation[]
  userRoles            UserRole[]
  userPermissions      UserPermission[]
  assignedRoles        UserRole[]           @relation("RoleAssigner")
  grantedPermissions   UserPermission[]     @relation("PermissionGranter")
  // Article Review relations
  reviewsSubmitted     ArticleReview[]      @relation("ReviewSubmitter")
  reviewsAssigned      ArticleReview[]      @relation("ReviewAssignee")
  reviewAssignments    ArticleReview[]      @relation("ReviewAssigner")
  reviewsCompleted     ArticleReview[]      @relation("ArticleReviewer")
  // Notification relation
  notifications        Notification[]
  // Media relation
  uploadedMedia        WikiMedia[]          @relation("UploadedMedia")
  // Notification preferences relation
  notificationPreferences UserNotificationPreference?
}

// Dental Locations
model Location {
  id          String         @id @default(cuid())
  name        String
  address     String?
  city        String?
  state       String?
  zipCode     String?
  phone       String?
  email       String?
  timezone    String         @default("America/Edmonton")
  hours       Json?          // Store weekly hours as JSON
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  users       UserLocation[]
  userRoles   UserRole[]

  @@index([isActive])
}

// User-Location Assignment (users can work at multiple locations)
model UserLocation {
  id         String   @id @default(cuid())
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  isPrimary  Boolean  @default(false)
  isActive   Boolean  @default(true)
  startDate  DateTime @default(now())
  endDate    DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
}

// User Types (Super Admin, Corporate, Location Staff)
model UserType {
  id             String   @id
  name           String
  description    String?
  hierarchyLevel Int      @default(0) // Lower = higher authority (0=SuperAdmin, 1=Corporate, 2=Location)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  roles          Role[]
}

// Roles within User Types
model Role {
  id           String           @id
  name         String
  description  String?
  userTypeId   String
  userType     UserType         @relation(fields: [userTypeId], references: [id])
  dataScope    DataScope        @default(LOCATION)
  isDefault    Boolean          @default(false)
  isProtected  Boolean          @default(false)
  isActive     Boolean          @default(true)
  displayOrder Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  permissions  RolePermission[]
  userRoles    UserRole[]
  courseAccess CourseRoleAccess[]

  @@index([userTypeId])
  @@index([isActive])
}

// Permissions
model Permission {
  id              String           @id
  name            String
  description     String?
  category        String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@index([category])
}

// Role-Permission Assignment
model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// User Role Assignment (can be location-specific)
model UserRole {
  id           String    @id @default(cuid())
  userId       String    @db.Uuid
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId       String
  role         Role      @relation(fields: [roleId], references: [id])
  locationId   String?
  location     Location? @relation(fields: [locationId], references: [id])
  isActive     Boolean   @default(true)
  expiresAt    DateTime?
  assignedById String?   @db.Uuid
  assignedBy   User?     @relation("RoleAssigner", fields: [assignedById], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, roleId, locationId])
  @@index([userId])
  @@index([roleId])
  @@index([locationId])
}

// User Permission Overrides
model UserPermission {
  id           String     @id @default(cuid())
  userId       String     @db.Uuid
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granted      Boolean
  reason       String?
  grantedById  String?    @db.Uuid
  grantedBy    User?      @relation("PermissionGranter", fields: [grantedById], references: [id])
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// Data Scope Enum
enum DataScope {
  SELF
  LOCATION
  ALL_LOCATIONS
  GLOBAL
}

// Wiki Media Models
model WikiMedia {
  id              String             @id @default(cuid())

  // File Information
  key             String             @unique // S3/Spaces key
  url             String             // Public CDN URL
  filename        String             // Original filename
  contentType     String             // MIME type
  size            Int                // File size in bytes

  // Metadata
  width           Int?               // Image width (if image)
  height          Int?               // Image height (if image)
  alt             String?            // Alt text for accessibility
  description     String?            @db.Text // User-provided description
  title           String?            // Custom title (defaults to filename)

  // Organization
  tags            WikiMediaTag[]     // Many-to-many relationship with tags

  // Ownership & Tracking
  uploadedById    String             @db.Uuid
  uploadedBy      User               @relation("UploadedMedia", fields: [uploadedById], references: [id], onDelete: Cascade)
  module          String?            // Which module uploaded this (wiki, lms, etc.)

  // Usage Tracking
  usedInArticles  WikiArticleMedia[]
  usageCount      Int                @default(0) // Denormalized count for quick queries

  // Status & Lifecycle
  status          MediaStatus        @default(ACTIVE)
  uploadedAt      DateTime           @default(now())
  lastUsedAt      DateTime?          // Last time it was added to an article
  deletedAt       DateTime?          // Soft delete timestamp

  // Cleanup tracking
  isOrphaned      Boolean            @default(false)
  orphanedAt      DateTime?

  @@index([uploadedById])
  @@index([status])
  @@index([isOrphaned, orphanedAt])
  @@index([contentType])
  @@index([uploadedAt])
}

model WikiArticleMedia {
  id        String      @id @default(cuid())

  articleId String
  article   WikiArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  mediaId   String
  media     WikiMedia   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  addedAt   DateTime    @default(now())

  @@unique([articleId, mediaId])
  @@index([articleId])
  @@index([mediaId])
}

model WikiMediaTag {
  id          String      @id @default(cuid())

  mediaId     String
  media       WikiMedia   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  tagId       String
  tag         MediaTag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  addedAt     DateTime    @default(now())

  @@unique([mediaId, tagId])
  @@index([mediaId])
  @@index([tagId])
}

model MediaTag {
  id          String          @id @default(cuid())
  name        String          @unique
  slug        String          @unique
  description String?         @db.Text
  color       String?         // Hex color for visual organization

  media       WikiMediaTag[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([name])
}

model MediaCleanupLog {
  id           String        @id @default(cuid())

  // What was cleaned
  mediaId      String?       // Null if batch operation
  mediaKey     String        // S3 key for reference
  mediaUrl     String        // URL for reference

  // Why it was cleaned
  reason       CleanupReason

  // When and by whom
  cleanedAt    DateTime      @default(now())
  cleanedBy    String?       @db.Uuid // User ID if manual, null if automatic
  isAutomatic  Boolean       @default(true)

  // Results
  success      Boolean
  errorMessage String?

  @@index([cleanedAt])
  @@index([isAutomatic])
}

enum MediaStatus {
  ACTIVE       // Currently in use or recently uploaded
  ORPHANED     // Not used in any published article
  DELETED      // Soft deleted
}

enum CleanupReason {
  ORPHANED_EXPIRED  // Orphaned for X days
  MANUAL_DELETE     // User deleted
  ADMIN_CLEANUP     // Admin bulk cleanup
  ARTICLE_DELETED   // Parent article deleted
}

// Wiki Models
model WikiCategory {
  id          String                    @id @default(cuid())
  name        String
  slug        String                    @unique
  description String?
  icon        String?
  parentId    String?
  parent      WikiCategory?             @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    WikiCategory[]            @relation("CategoryHierarchy")
  articles    WikiArticleCategory[]
  order       Int                       @default(0)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
}

model WikiArticleCategory {
  id          String       @id @default(cuid())
  articleId   String
  article     WikiArticle  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  categoryId  String
  category    WikiCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  isPrimary   Boolean      @default(false)
  createdAt   DateTime     @default(now())

  @@unique([articleId, categoryId])
  @@index([articleId])
  @@index([categoryId])
}

model WikiArticle {
  id           String                @id @default(cuid())
  title        String
  slug         String                @unique
  content      String                @db.Text
  contentPlain String                @db.Text
  excerpt      String?
  coverImage   String?
  status       ArticleStatus         @default(DRAFT)
  isFeatured   Boolean               @default(false)
  categories   WikiArticleCategory[]
  authorId     String                @db.Uuid
  author       User                  @relation(fields: [authorId], references: [id])
  tags         WikiTag[]
  versions     WikiArticleVersion[]
  reviews      ArticleReview[]
  media        WikiArticleMedia[]
  views        Int                   @default(0)
  order        Int                   @default(0)
  publishedAt  DateTime?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@index([authorId])
  @@index([status])
  @@index([isFeatured])
}

model WikiArticleVersion {
  id         String      @id @default(cuid())
  articleId  String
  article    WikiArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  title      String
  content    String      @db.Text
  authorId   String      @db.Uuid
  author     User        @relation(fields: [authorId], references: [id])
  createdAt  DateTime    @default(now())

  @@index([articleId])
}

model WikiTag {
  id       String        @id @default(cuid())
  name     String        @unique
  slug     String        @unique
  articles WikiArticle[]
}

// WikiEmbedding model - requires pgvector extension (uncomment when using production DB with pgvector)
// model WikiEmbedding {
//   id         String   @id @default(cuid())
//   articleId  String   @unique
//   embedding  Unsupported("vector(1536)")
//   chunkIndex Int      @default(0)
//   chunkText  String   @db.Text
//   createdAt  DateTime @default(now())
//   updatedAt  DateTime @updatedAt
//
//   @@index([articleId])
// }

model WikiSearchLog {
  id        String   @id @default(cuid())
  query     String
  userId    String?     @db.Uuid
  results   Int
  createdAt DateTime @default(now())
}

// Article Review model for wiki content workflow
model ArticleReview {
  id                String        @id @default(cuid())
  articleId         String
  article           WikiArticle   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleVersionId  String?       // Snapshot of version being reviewed

  // Submission info
  submittedById     String        @db.Uuid
  submittedBy       User          @relation("ReviewSubmitter", fields: [submittedById], references: [id])
  submittedAt       DateTime      @default(now())

  // Assignment
  assignedToId      String?       @db.Uuid
  assignedTo        User?         @relation("ReviewAssignee", fields: [assignedToId], references: [id])
  assignedAt        DateTime?
  assignedById      String?       @db.Uuid
  assignedBy        User?         @relation("ReviewAssigner", fields: [assignedById], references: [id])

  // Review outcome
  status            ReviewStatus  @default(PENDING)
  reviewedById      String?       @db.Uuid
  reviewedBy        User?         @relation("ArticleReviewer", fields: [reviewedById], references: [id])
  reviewedAt        DateTime?

  // Feedback
  feedback          String?       @db.Text  // Shown to author on rejection
  internalNotes     String?       @db.Text  // Reviewer-only notes

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([articleId])
  @@index([submittedById])
  @@index([assignedToId])
  @@index([status])
}

// Notification model for in-app notifications
model Notification {
  id              String           @id @default(cuid())
  userId          String           @db.Uuid
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            NotificationType
  title           String
  message         String           @db.Text

  // Reference to related entity
  referenceType   String?          // 'article', 'review', 'course', etc.
  referenceId     String?          // ID of the referenced entity
  actionUrl       String?          // URL to navigate to

  isRead          Boolean          @default(false)
  readAt          DateTime?

  createdAt       DateTime         @default(now())

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

enum ArticleStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

enum NotificationType {
  // Wiki notifications
  ARTICLE_SUBMITTED_FOR_REVIEW
  ARTICLE_REVIEW_ASSIGNED
  ARTICLE_APPROVED
  ARTICLE_REJECTED
  ARTICLE_PUBLISHED
  // General notifications (for future use)
  SYSTEM_ANNOUNCEMENT
  COURSE_ASSIGNED
  COURSE_COMPLETED
}

// LMS Models
model CourseCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  color       String   @default("#6366f1")
  courses     Course[]
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Course {
  id                 String         @id @default(cuid())
  title              String
  slug               String         @unique
  description        String?        @db.Text
  shortDescription   String?
  coverImage         String?
  difficulty         CourseDifficulty @default(BEGINNER)
  duration           Int?
  learningObjectives String[]
  prerequisites      String[]
  tags               String[]
  categoryId         String?
  category           CourseCategory? @relation(fields: [categoryId], references: [id])
  modules            CourseModule[]
  enrollments        Enrollment[]
  allowedRoles       CourseRoleAccess[]
  isPublished        Boolean        @default(false)
  isFeatured         Boolean        @default(false)
  restrictByRole     Boolean        @default(false)
  rating             Float          @default(0)
  ratingCount        Int            @default(0)
  createdById        String?        @db.Uuid
  createdBy          User?          @relation("CourseCreator", fields: [createdById], references: [id])
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([categoryId])
  @@index([isPublished])
  @@index([createdById])
}

model CourseModule {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  order       Int      @default(0)
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
}

model Lesson {
  id             String           @id @default(cuid())
  title          String
  content        String?          @db.Text
  lessonType     LessonType       @default(TEXT)
  duration       Int?
  order          Int              @default(0)
  moduleId       String
  module         CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes        Quiz[]
  lessonProgress LessonProgress[]
  bookmarks      LessonBookmark[]
  notes          LessonNote[]
  videoUrl       String?
  attachments    String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([moduleId])
}

model Enrollment {
  id              String           @id @default(cuid())
  userId          String           @db.Uuid
  user            User             @relation(fields: [userId], references: [id])
  courseId        String
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status          EnrollmentStatus @default(ACTIVE)
  progress        Float            @default(0)
  completedAt     DateTime?
  lastAccessedAt  DateTime?
  lessonProgress  LessonProgress[]
  quizAttempts    QuizAttempt[]
  certificate     Certificate?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Certificate {
  id           String     @id @default(cuid())
  enrollmentId String     @unique
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  certificateNumber String @unique
  issuedAt     DateTime   @default(now())
  pdfUrl       String?
  
  @@index([certificateNumber])
}

model LessonProgress {
  id           String     @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId     String
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  isCompleted  Boolean    @default(false)
  completedAt  DateTime?
  timeSpent    Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
}

model LessonBookmark {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model LessonNote {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Quiz {
  id            String        @id @default(cuid())
  title         String
  description   String?
  lessonId      String
  lesson        Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions     QuizQuestion[]
  passingScore  Float         @default(70)
  timeLimit     Int?
  attempts      QuizAttempt[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([lessonId])
}

model QuizQuestion {
  id           String             @id @default(cuid())
  quizId       String
  quiz         Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  question     String             @db.Text
  questionType QuestionType       @default(MULTIPLE_CHOICE)
  explanation  String?            @db.Text
  order        Int                @default(0)
  points       Int                @default(1)
  answers      QuizAnswer[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([quizId])
}

model QuizAnswer {
  id         String       @id @default(cuid())
  questionId String
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  text       String
  isCorrect  Boolean      @default(false)
  order      Int          @default(0)
  createdAt  DateTime     @default(now())

  @@index([questionId])
}

model QuizAttempt {
  id           String     @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  quizId       String
  quiz         Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  score        Float
  passed       Boolean
  answers      Json
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  createdAt    DateTime   @default(now())

  @@index([enrollmentId])
  @@index([quizId])
}

model AICourseGeneration {
  id            String   @id @default(cuid())
  courseId      String?
  generationType String
  inputData     Json?
  outputData    Json?
  tokensUsed    Int      @default(0)
  model         String?
  status        String   @default("pending")
  error         String?
  userId        String?  @db.Uuid
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CourseRoleAccess {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([courseId, roleId])
  @@index([courseId])
  @@index([roleId])
}

enum CourseDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  TEXT
  VIDEO
  INTERACTIVE
  QUIZ
  ASSIGNMENT
  DOCUMENT
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

// Branding Settings (singleton - only one row)
model BrandingSettings {
  id        String   @id @default("default")
  settings  Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// Chat Widget Settings (singleton - only one row)
model ChatWidgetSettings {
  id                String   @id @default("default")
  isEnabled         Boolean  @default(true)
  theme             String   @default("light") // light, dark
  accentColor       String   @default("3ec972") // hex without #
  position          String   @default("right") // left, right
  greeting          String   @default("Hi! How can I help you today?")
  headerTitle       String   @default("Living Wellness Dental")
  headerSubtitle    String   @default("Ask us anything")
  inputPlaceholder  String   @default("Type your message...")
  systemPrompt      String?  @db.Text // Custom system prompt for the AI
  allowedDomains    String[] @default([]) // Domains where widget is allowed
  rateLimitPerMin   Int      @default(10) // Rate limit per IP per minute
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())
}

// =============================================================================
// MESSAGING SYSTEM (Email & SMS)
// =============================================================================

// Global Messaging Settings (singleton)
model MessagingSettings {
  id                    String   @id @default("default")

  // Email (Resend) Configuration
  emailEnabled          Boolean  @default(false)
  resendApiKey          String?  // Encrypted in production
  fromEmail             String?  // e.g., "notifications@livingwellnessdental.com"
  fromName              String?  // e.g., "Living Wellness Dental"
  replyToEmail          String?  // e.g., "support@livingwellnessdental.com"

  // SMS (Twilio) Configuration
  smsEnabled            Boolean  @default(false)
  twilioAccountSid      String?  // Encrypted in production
  twilioAuthToken       String?  // Encrypted in production
  twilioPhoneNumber     String?  // e.g., "+18005551234"

  // Default Preferences for new users
  defaultEmailOptIn     Boolean  @default(true)
  defaultSmsOptIn       Boolean  @default(false)

  // Rate Limits
  emailRateLimitPerHour Int      @default(100)
  smsRateLimitPerHour   Int      @default(50)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// User Notification Preferences
model UserNotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique @db.Uuid
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email Preferences
  emailEnabled          Boolean  @default(true)
  emailNotifications    Boolean  @default(true)   // Transactional notifications
  emailMarketing        Boolean  @default(false)  // Marketing emails (requires explicit consent)
  emailDigest           Boolean  @default(false)  // Daily/weekly digest
  digestFrequency       DigestFrequency @default(WEEKLY)

  // SMS Preferences
  smsEnabled            Boolean  @default(false)
  smsNotifications      Boolean  @default(false)
  smsMarketing          Boolean  @default(false)

  // Phone for SMS (can be different from User.phone)
  smsPhoneNumber        String?
  smsPhoneVerified      Boolean  @default(false)
  smsPhoneVerifiedAt    DateTime?

  // Consent tracking
  emailConsentAt        DateTime?
  emailConsentIp        String?
  smsConsentAt          DateTime?
  smsConsentIp          String?
  marketingConsentAt    DateTime?
  marketingConsentIp    String?

  // Unsubscribe tracking
  emailUnsubscribedAt   DateTime?
  smsUnsubscribedAt     DateTime?
  unsubscribeToken      String   @unique @default(cuid()) // For one-click unsubscribe

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([unsubscribeToken])
}

enum DigestFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

// Email Templates
model EmailTemplate {
  id              String              @id @default(cuid())
  name            String              // Internal name
  slug            String              @unique // e.g., "welcome", "password-reset"
  subject         String              // Email subject (supports variables)
  htmlContent     String              @db.Text // HTML content (supports variables)
  textContent     String?             @db.Text // Plain text fallback
  description     String?             // Admin description
  category        EmailTemplateCategory @default(TRANSACTIONAL)

  // Template variables documentation
  variables       Json?               // { "name": "User's name", "link": "Action URL" }

  // Status
  isActive        Boolean             @default(true)
  isSystem        Boolean             @default(false) // System templates can't be deleted

  // Versioning
  version         Int                 @default(1)

  // Tracking
  sentCount       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  emailMessages   EmailMessage[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
}

enum EmailTemplateCategory {
  TRANSACTIONAL   // Password reset, verification, etc.
  NOTIFICATION    // In-app notification emails
  MARKETING       // Marketing campaigns
  DIGEST          // Daily/weekly digests
}

// SMS Templates
model SmsTemplate {
  id              String            @id @default(cuid())
  name            String            // Internal name
  slug            String            @unique // e.g., "verification-code"
  content         String            // SMS content (max ~160 chars for single SMS)
  description     String?           // Admin description
  category        SmsTemplateCategory @default(TRANSACTIONAL)

  // Template variables documentation
  variables       Json?             // { "code": "Verification code" }

  // Status
  isActive        Boolean           @default(true)
  isSystem        Boolean           @default(false)

  // Versioning
  version         Int               @default(1)

  // Tracking
  sentCount       Int               @default(0)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  smsMessages     SmsMessage[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
}

enum SmsTemplateCategory {
  TRANSACTIONAL   // Verification codes, confirmations
  NOTIFICATION    // In-app notification SMS
  MARKETING       // Marketing messages
  REMINDER        // Appointment reminders, etc.
}

// Email Message Log
model EmailMessage {
  id              String            @id @default(cuid())

  // Recipient
  toEmail         String
  toName          String?
  userId          String?           @db.Uuid // If sent to a registered user

  // Content
  subject         String
  htmlContent     String            @db.Text
  textContent     String?           @db.Text

  // Template (if used)
  templateId      String?
  template        EmailTemplate?    @relation(fields: [templateId], references: [id])
  templateVariables Json?           // Variables used for this send

  // Delivery Status
  status          EmailStatus       @default(QUEUED)
  resendId        String?           // Resend message ID

  // Delivery Events
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  complainedAt    DateTime?         // Spam complaint

  // Error tracking
  errorMessage    String?
  retryCount      Int               @default(0)
  lastRetryAt     DateTime?

  // Metadata
  category        EmailTemplateCategory @default(TRANSACTIONAL)
  referenceType   String?           // 'notification', 'article', etc.
  referenceId     String?           // ID of related entity

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([toEmail])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
  @@index([resendId])
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  FAILED
}

// SMS Message Log
model SmsMessage {
  id              String            @id @default(cuid())

  // Recipient
  toPhone         String
  userId          String?           @db.Uuid // If sent to a registered user

  // Content
  content         String            @db.Text

  // Template (if used)
  templateId      String?
  template        SmsTemplate?      @relation(fields: [templateId], references: [id])
  templateVariables Json?           // Variables used for this send

  // Delivery Status
  status          SmsStatus         @default(QUEUED)
  twilioSid       String?           // Twilio message SID

  // Delivery Events
  sentAt          DateTime?
  deliveredAt     DateTime?
  failedAt        DateTime?

  // Pricing (from Twilio)
  segments        Int               @default(1) // Number of SMS segments
  price           Float?            // Cost in USD

  // Error tracking
  errorCode       String?           // Twilio error code
  errorMessage    String?
  retryCount      Int               @default(0)
  lastRetryAt     DateTime?

  // Metadata
  category        SmsTemplateCategory @default(TRANSACTIONAL)
  referenceType   String?           // 'notification', 'verification', etc.
  referenceId     String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([toPhone])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
  @@index([twilioSid])
}

enum SmsStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  UNDELIVERED
  FAILED
}
